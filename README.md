# go-tesma-api

### データベース設計
<img src="https://github.com/nagaoka1166/go-tesma-api/assets/69971830/005f04cc-1029-43fc-9fd0-021890569815" width="500">


## アーキテクチャ
このプロジェクトは、クリーンアーキテクチャの原則に基づいて設計されています。クリーンアーキテクチャの目的は、フレームワーク、データベース、UIなどの外部の詳細からビジネスロジックを独立させここ変更やテストを行いやすいように機能の独立性を担保しております。

| 層の名前                                  | 責務 |
| ---------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| エンティティ層 (app/domain/entity) | アプリケーションの中心的ビジネスルールを表現する層                                      |
| ユースケース層 (app/domain/usecase)                          | プリケーションの具体的なビジネスロジックを担当。エンティティを操作を実装する。 |
| インターフェース層 (app/interfaces)                                  |アプリケーションの入出力のためのインターフェース                         |
| インフラストラクチャ (app/infrastructure)                      | アプリケーションのインフラストラクチャ関連のロジックを管理している。外部のフレームワークやツール、データベースなどとの接続。具体的な技術やフレームワークの実装が含まれている。


## Firebase Authentication の技術選定の背景

Firebase Authenticationの採用により、以下のサービスや機能が利用可能となります。

### 1. **Firebase Console**
- ユーザーの管理、確認、削除などの操作が容易に行えます。

### 2. **Firebase Cloud Messaging (FCM)**
- プッシュ通知の送信をサポートするサービスです。

### 3. **Firebase Analytics**
- ユーザーの行動をトラッキングして分析することが可能です。

加えて、GoはFirebase Authenticationに公式にサポートされており、認証関連の実装が効率的に行えます。このようなメリットから、本アプリケーションでFirebase Authenticationを採用することとしました。

## JWT認証

本アプリケーションでは、ユーザー認証にJWT (JSON Web Token) 認証を採用しています。


### JWT認証の背景

JWT認証は、ステートレスでセキュアな方法でユーザー認証情報をトークンとして交換する方式です。Firebase Authenticationとの相性が良く、以下のような理由から本アプリケーションでの採用を決定しました。

1. **セキュリティ**: JWTは暗号化されており、中間者攻撃を防ぐことができる
2. **ステートレス性**: JWTはサーバーサイドでセッションを保持する必要がないため、スケーラビリティが高い。
3. **Firebaseとの統合**: Firebase AuthenticationはJWTをサポートしており、認証処理の実装が容易だったため。

[一方でリスクがあり、そのリスクと対策については「JWTの認証のデメリットと対策」で説明しております。](#JWTの認証のデメリットと対策)

以下は認証の流れです。

### 1. 認証後の処理

- **IDトークンの返却**: ログイン時やサインアップ時に入力される情報がサーバーサイドとFirebase authで承認された際、IDトークンが返されます。
  
- **トークンの保存**: クライアント側では返却されたIDトークンを保存します。（保存先は未定）

### 2. 再認証

リクエスト時にIDトークンをヘッダーに含め、サーバーサイドで認証を行います。

### 3. トークンの更新

IDトークンの有効期間は短いため、期限切れ時に更新トークンを使用して新しいIDトークンを取得します。これにより、ユーザーは再ログインの必要がなくなります。

### <a id="JWTの認証のデメリットと対策"></a>4. JWTの認証のデメリットと対策

更新トークンは永続的に有効であり、セキュリティの問題があるとされています。Firebase Authenticationでは、以下の条件で更新トークンが無効となります。([Firebaseの公式ドキュメント参照](https://firebase.google.com/docs/auth/admin/manage-sessions?hl=ja))

- ユーザーが削除される場合
- ユーザーが無効になる場合
- ユーザーのアカウントで大きな変更が検出される場合（例: パスワードやメールアドレスの変更）

上記以外のユースケースでら更新トークンを削除したい場合は、クライアント側で`RevokeRefreshTokens`メソッドを使用します。被験者募集の申請時にセキュリティ上の理由から更新トークンを削除する予定です。

